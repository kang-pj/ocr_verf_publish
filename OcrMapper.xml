<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.refine.ocr.mapper.OcrMapper">
    
    <!-- OCR 문서 건수 조회 -->
    <select id="getOcrDocumentCount" parameterType="map" resultType="int">
        SELECT COUNT(*)
        FROM ocr_doc_inf
        WHERE 1=1
        <if test="ctrl_yr != null and ctrl_yr != ''">
            AND ctrl_yr = #{ctrl_yr}
        </if>
        <if test="inst_cd != null and inst_cd != ''">
            AND inst_cd = #{inst_cd}
        </if>
        <if test="prdt_cd != null and prdt_cd != ''">
            AND prdt_cd = #{prdt_cd}
        </if>
    </select>
    
    <!-- OCR 문서 목록 조회 -->
    <select id="getOcrDocumentList" parameterType="map" resultType="com.refine.ocr.vo.OcrInfoVO">
        SELECT
            ctrl_yr,
            inst_cd,
            prdt_cd,
            ctrl_no,
            CONCAT(ctrl_yr, '-', inst_cd, '-', prdt_cd, '-', ctrl_no) AS ctrl_key,
            doc_tp_cd,
            ocr_doc_no,
            doc_fl_nm,
            doc_fl_sav_pth_nm,
            doc_fl_ext,
            ins_dttm,
            ins_id,
            enc_yn
        FROM ocr_doc_inf
        WHERE 1=1
        <if test="ctrl_yr != null and ctrl_yr != ''">
            AND ctrl_yr = #{ctrl_yr}
        </if>
        <if test="inst_cd != null and inst_cd != ''">
            AND inst_cd = #{inst_cd}
        </if>
        <if test="prdt_cd != null and prdt_cd != ''">
            AND prdt_cd = #{prdt_cd}
        </if>
        <if test="ins_id != null and ins_id != ''">
            AND ins_id = #{ins_id}
        </if>
        ORDER BY ins_dttm DESC
        <if test="paging != null and num != null">
            LIMIT #{num} OFFSET #{paging}
        </if>
    </select>
    
    <!-- OCR 문서 상세 조회 -->
    <!-- OCR 문서 상세 조회 (ocr_doc_no 기반) -->
    <select id="getOcrDocumentDetail" parameterType="map" resultType="com.refine.ocr.vo.OcrInfoVO">
        SELECT
            INF.OCR_DOC_NO,
            INF.CTRL_YR,
            INF.INST_CD,
            INF.PRDT_CD,
            INF.CTRL_NO,
            INF.DOC_TP_CD,
            INF.DOC_FL_SAV_PTH_NM,
            INF.DOC_FL_EXT,
            INF.OCR_YN,
            TO_CHAR(INF.INS_DTTM, 'YYYY-MM-DD HH24:MI:SS') AS INS_DTTM,
            RSLT.OCR_RSLT_NO,
            <if test='type == "original"'>
                PKG_PGCRYPTO$DECRYPT(RSLT.OCR_CNTS_ORIGINAL) AS OCR_CNTS,
                PKG_PGCRYPTO$DECRYPT(RSLT.OCR_CNTS_ORIGINAL)::JSON ->> 'docTitle' AS DOC_TITLE,
            </if>
            <if test='type == "modified"'>
                PKG_PGCRYPTO$DECRYPT(RSLT.OCR_CNTS) AS OCR_CNTS,
                PKG_PGCRYPTO$DECRYPT(RSLT.OCR_CNTS)::JSON ->> 'docTitle' AS DOC_TITLE,
            </if>
            <if test='type == null'>
                PKG_PGCRYPTO$DECRYPT(RSLT.OCR_CNTS) AS OCR_CNTS,
                PKG_PGCRYPTO$DECRYPT(RSLT.OCR_CNTS)::JSON ->> 'docTitle' AS DOC_TITLE,
            </if>
            RSLT.SAVE_YN,
            RSLT.SAVE_DTTM,
            RSLT.VERF_YN,
            RSLT.VERF_DTTM,
            RSLT.REPLACED,
            PKG_PGCRYPTO$DECRYPT(JSN.JSON_VALUE) AS JSON_VALUE
        FROM RFDB.OCR_DOC_INF INF
        LEFT JOIN RFDB.OCR_DOC_RSLT RSLT
            ON INF.OCR_DOC_NO = RSLT.OCR_DOC_NO
        LEFT JOIN RFDB.OCR_DOC_JSON JSN
            ON RSLT.OCR_RSLT_NO = JSN.OCR_RSLT_NO
        WHERE INF.OCR_DOC_NO = #{ocr_doc_no}
        ORDER BY RSLT.ins_dttm DESC
        LIMIT 1
    </select>
    
    <!-- 관리번호별 서류 목록 조회 -->
    <select id="getDocumentListByCtrlNo" parameterType="map" resultType="com.refine.ocr.vo.OcrInfoVO">
        SELECT
            INF.INST_CD,
            INF.PRDT_CD,
            INF.DOC_TP_CD,
            COUNT(*) AS DOC_PAGE,
            MAX(INF.OCR_YN) AS OCR_YN,
            MIN(NULLIF(NULLIF(RSLT.DOC_TITLE, ''), 'Undefined')) AS DOC_TITLE
        FROM RFDB.OCR_DOC_INF INF
        LEFT JOIN RFDB.OCR_DOC_RSLT RSLT
            ON INF.OCR_DOC_NO = RSLT.OCR_DOC_NO
        WHERE 1=1
            AND INF.CTRL_YR = #{ctrl_yr}
            AND INF.INST_CD = #{inst_cd}
            AND INF.PRDT_CD = #{prdt_cd}
            AND INF.CTRL_NO = #{ctrl_no}
        GROUP BY INF.INST_CD, INF.PRDT_CD, INF.DOC_TP_CD
        ORDER BY INF.DOC_TP_CD
    </select>
    
    <!-- OCR 결과 텍스트 조회 -->
    <select id="getOcrResultText" parameterType="map" resultType="com.refine.ocr.vo.OcrInfoVO">
        SELECT *
        FROM ocr_doc_rslt
        WHERE ocr_doc_no = #{ocr_doc_no}
        ORDER BY item_cd
    </select>
    
    <!-- OCR 문서 번호 리스트 조회 -->
    <select id="getOcrDocNoList" parameterType="map" resultType="String">
        SELECT ocr_doc_no
        FROM ocr_doc_inf
        WHERE ctrl_yr = #{ctrl_yr}
        AND inst_cd = #{inst_cd}
        AND prdt_cd = #{prdt_cd}
        AND ctrl_no = #{ctrl_no}
        ORDER BY ins_dttm DESC
    </select>
    
    <!-- 검증 상태 업데이트 -->
    <update id="updateVerificationStatus" parameterType="map">
        UPDATE ocr_doc_inf
        SET vrfy_stat_cd = #{vrfy_stat_cd},
            upd_dttm = NOW()
        WHERE ocr_doc_no = #{ocr_doc_no}
    </update>
    
    <!-- OCR 상태 업데이트 -->
    <update id="updateOcrStatus" parameterType="map">
        UPDATE ocr_doc_inf
        SET ocr_yn = #{ocr_yn},
            upd_dttm = NOW()
        WHERE ocr_doc_no = #{ocr_doc_no}
    </update>
    
    <!-- 서류 한글명 조회 (프로시저 사용) -->
    <select id="getDocumentName" parameterType="map" resultType="String">
        WITH sys_cls AS (
            SELECT rfdb.get_sys_cls_cd(#{inst_cd}, #{prdt_cd}) AS sys_cls_cd
        )
        SELECT 
            CASE 
                -- KRH (모바일반환보증)
                WHEN (SELECT sys_cls_cd FROM sys_cls) = 'KRH' THEN
                    CASE 
                        -- prdt_cd가 830이면 nv_hug_doc_inf 테이블
                        WHEN #{prdt_cd} = '830' THEN
                            (SELECT doc_nm FROM nv_hug_doc_inf WHERE doc_cd = #{doc_tp_cd} LIMIT 1)
                        -- prdt_cd가 820이면 hug_doc_inf 테이블
                        WHEN #{prdt_cd} = '820' THEN
                            (SELECT doc_nm FROM hug_doc_inf WHERE doc_cd = #{doc_tp_cd} LIMIT 1)
                        ELSE NULL
                    END
                -- KH, JL (전세보증)
                WHEN (SELECT sys_cls_cd FROM sys_cls) IN ('KH', 'JL') THEN
                    (SELECT doc_tp_nm FROM l_doc_tp_inf 
                     WHERE doc_tp_cd = #{doc_tp_cd} 
                     AND sys_cls_cd = (SELECT sys_cls_cd FROM sys_cls) 
                     LIMIT 1)
                ELSE NULL
            END AS doc_name
    </select>
    
    <!-- 이미지 정보 조회 -->
    <select id="getImageInfo" parameterType="map" resultType="com.refine.ocr.vo.OcrInfoVO">
        SELECT *
        FROM ocr_doc_inf
        WHERE ocr_doc_no = #{ocr_doc_no}
    </select>
    
    <!-- 상품 분류 조회 (프로시저 사용) -->
    <select id="getSysClsCd" parameterType="map" resultType="String" statementType="CALLABLE">
        {call rfdb.get_sys_cls_cd(#{instCd, mode=IN, jdbcType=VARCHAR}, #{prdtCd, mode=IN, jdbcType=VARCHAR})}
    </select>
    
    <!-- 최대 CTRL_NO 조회 -->
    <select id="getMaxCtrlNo" parameterType="map" resultType="String">
        SELECT LPAD(MAX(CAST(ctrl_no AS INTEGER))::TEXT, 6, '0')
        FROM ocr_doc_inf
        WHERE inst_cd = #{inst_cd}
        AND prdt_cd = #{prdt_cd}
    </select>
    
    <!-- 사용자별 OCR 문서 번호 조회 -->
    <select id="getOcrDocNoListByUserId" parameterType="map" resultType="String">
        SELECT ocr_doc_no
        FROM ocr_doc_inf
        WHERE inst_cd = #{inst_cd}
        AND prdt_cd = #{prdt_cd}
        AND ins_id = #{ins_id}
    </select>
    
    <!-- 사용자 테스트 파일 경로 리스트 조회 -->
    <select id="getUserTestFilePathList" parameterType="map" resultType="String">
        SELECT doc_fl_sav_pth_nm
        FROM ocr_doc_inf
        WHERE inst_cd = #{inst_cd}
        AND prdt_cd = #{prdt_cd}
        AND ins_id = #{ins_id}
        AND doc_fl_sav_pth_nm IS NOT NULL
    </select>
    
    <!-- OCR 결과 삭제 -->
    <delete id="deleteOcrResult" parameterType="map">
        DELETE FROM ocr_doc_rslt
        WHERE ocr_doc_no = #{ocr_doc_no}
    </delete>
    
    <!-- OCR 문서 삭제 -->
    <delete id="deleteOcrDocument" parameterType="map">
        DELETE FROM ocr_doc_inf
        WHERE ocr_doc_no = #{ocr_doc_no}
        AND inst_cd = '99'
        AND prdt_cd = 'OCR'
    </delete>
    
    <!-- 사용자 테스트 문서 삭제 -->
    <delete id="deleteUserTestDocuments" parameterType="map">
        DELETE FROM ocr_doc_inf
        WHERE inst_cd = #{inst_cd}
        AND prdt_cd = #{prdt_cd}
        AND ins_id = #{ins_id}
    </delete>
    
    <!-- OCR 문서 등록 -->
    <insert id="insertOcrDocument" parameterType="map">
        INSERT INTO ocr_doc_inf (
            ocr_doc_no,
            doc_fl_no,
            ctrl_yr,
            inst_cd,
            prdt_cd,
            ctrl_no,
            doc_tp_cd,
            doc_fl_nm,
            doc_fl_sav_pth_nm,
            doc_fl_ext,
            ins_dttm,
            ins_id,
            upd_dttm,
            upd_id,
            enc_yn,
            menu_cd,
            priority
        ) SELECT
            nextval('seq_ocr_doc_no'),
            nextval('seq_doc_fl_no'),
            #{ctrl_yr},
            #{inst_cd},
            #{prdt_cd},
            #{ctrl_no},
            #{doc_tp_cd},
            #{doc_fl_nm},
            #{doc_fl_sav_pth_nm},
            #{doc_fl_ext},
            NOW(),
            #{ins_id},
            NOW(),
            #{upd_id},
            #{enc_yn},
            #{menu_cd},
            #{priority}
        WHERE NOT EXISTS (
            SELECT 1
            FROM ocr_doc_inf
            WHERE ctrl_yr = #{ctrl_yr}
            AND inst_cd = #{inst_cd}
            AND prdt_cd = #{prdt_cd}
            AND ctrl_no = #{ctrl_no}
            AND doc_tp_cd = #{doc_tp_cd}
            AND doc_fl_nm = #{doc_fl_nm}
        )
    </insert>
    
    <!-- OCR 항목 코드 목록 조회 -->
    <select id="getOcrItemList" parameterType="map" resultType="com.refine.ocr.vo.OcrItemVO">
        SELECT
            inst_cd,
            prdt_cd,
            item_cd,
            item_nm,
            item_odr,
            use_yn,
            insr_id,
            TO_CHAR(ins_dttm, 'YYYY-MM-DD HH24:MI:SS') AS ins_dttm,
            updr_id,
            TO_CHAR(upd_dttm, 'YYYY-MM-DD HH24:MI:SS') AS upd_dttm
        FROM rfdb.c_ocr_doc_item
        WHERE inst_cd = #{inst_cd}
        AND prdt_cd = #{prdt_cd}
        <if test="keyword != null and keyword != ''">
            AND (item_cd LIKE '%' || #{keyword} || '%' OR item_nm LIKE '%' || #{keyword} || '%')
        </if>
        <if test="use_yn != null and use_yn != ''">
            AND use_yn = #{use_yn}
        </if>
        ORDER BY item_odr, item_cd
    </select>
    
    <!-- OCR 항목 코드 건수 조회 -->
    <select id="getOcrItemCount" parameterType="map" resultType="int">
        SELECT COUNT(*)
        FROM rfdb.c_ocr_doc_item
        WHERE inst_cd = #{inst_cd}
        AND prdt_cd = #{prdt_cd}
        <if test="keyword != null and keyword != ''">
            AND (item_cd LIKE '%' || #{keyword} || '%' OR item_nm LIKE '%' || #{keyword} || '%')
        </if>
        <if test="use_yn != null and use_yn != ''">
            AND use_yn = #{use_yn}
        </if>
    </select>
    
    <!-- OCR 항목 코드 중복 체크 -->
    <select id="checkOcrItemExists" parameterType="map" resultType="int">
        SELECT COUNT(*)
        FROM rfdb.c_ocr_doc_item
        WHERE inst_cd = #{inst_cd}
        AND prdt_cd = #{prdt_cd}
        AND item_cd = #{item_cd}
    </select>
    
    <!-- OCR 항목 코드 추가 -->
    <insert id="insertOcrItem" parameterType="map">
        INSERT INTO rfdb.c_ocr_doc_item (
            inst_cd,
            prdt_cd,
            item_cd,
            item_nm,
            item_odr,
            use_yn,
            insr_id,
            ins_dttm,
            updr_id,
            upd_dttm
        ) VALUES (
            #{inst_cd},
            #{prdt_cd},
            #{item_cd},
            #{item_nm},
            #{item_odr},
            #{use_yn},
            #{insr_id},
            NOW(),
            #{updr_id},
            NOW()
        )
    </insert>
    
    <!-- OCR 항목 코드 수정 -->
    <update id="updateOcrItem" parameterType="map">
        UPDATE rfdb.c_ocr_doc_item
        SET item_cd = #{item_cd},
            item_nm = #{item_nm},
            updr_id = #{updr_id},
            upd_dttm = NOW()
        WHERE inst_cd = #{inst_cd}
        AND prdt_cd = #{prdt_cd}
        AND item_cd = #{old_item_cd}
    </update>
    
    <!-- OCR 항목 코드 삭제 (use_yn 변경) -->
    <update id="deleteOcrItem" parameterType="map">
        UPDATE rfdb.c_ocr_doc_item
        SET use_yn = 'N',
            updr_id = #{updr_id},
            upd_dttm = NOW()
        WHERE inst_cd = #{inst_cd}
        AND prdt_cd = #{prdt_cd}
        AND item_cd = #{item_cd}
    </update>
    
    <!-- OCR 항목 코드 활성화 (use_yn 변경) -->
    <update id="activateOcrItem" parameterType="map">
        UPDATE rfdb.c_ocr_doc_item
        SET use_yn = 'Y',
            updr_id = #{updr_id},
            upd_dttm = NOW()
        WHERE inst_cd = #{inst_cd}
        AND prdt_cd = #{prdt_cd}
        AND item_cd = #{item_cd}
    </update>
    
</mapper>
