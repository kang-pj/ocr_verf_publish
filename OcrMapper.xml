<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.refine.ocr.mapper.OcrMapper">
    
    <!-- OCR 문서 건수 조회 -->
    <select id="getOcrDocumentCount" parameterType="map" resultType="int">
        SELECT COUNT(*)
        FROM ocr_doc_inf
        WHERE 1=1
        <if test="ctrl_yr != null and ctrl_yr != ''">
            AND ctrl_yr = #{ctrl_yr}
        </if>
        <if test="inst_cd != null and inst_cd != ''">
            AND inst_cd = #{inst_cd}
        </if>
        <if test="prdt_cd != null and prdt_cd != ''">
            AND prdt_cd = #{prdt_cd}
        </if>
    </select>
    
    <!-- OCR 문서 목록 조회 -->
    <select id="getOcrDocumentList" parameterType="map" resultType="com.refine.ocr.vo.OcrInfoVO">
        SELECT
            ctrl_yr,
            inst_cd,
            prdt_cd,
            ctrl_no,
            CONCAT(ctrl_yr, '-', inst_cd, '-', prdt_cd, '-', ctrl_no) AS ctrl_key,
            doc_tp_cd,
            ocr_doc_no,
            doc_fl_nm,
            doc_fl_sav_pth_nm,
            doc_fl_ext,
            ins_dttm,
            ins_id,
            enc_yn
        FROM ocr_doc_inf
        WHERE 1=1
        <if test="ctrl_yr != null and ctrl_yr != ''">
            AND ctrl_yr = #{ctrl_yr}
        </if>
        <if test="inst_cd != null and inst_cd != ''">
            AND inst_cd = #{inst_cd}
        </if>
        <if test="prdt_cd != null and prdt_cd != ''">
            AND prdt_cd = #{prdt_cd}
        </if>
        <if test="ins_id != null and ins_id != ''">
            AND ins_id = #{ins_id}
        </if>
        ORDER BY ins_dttm DESC
        <if test="paging != null and num != null">
            LIMIT #{num} OFFSET #{paging}
        </if>
    </select>
    
    <!-- OCR 문서 상세 조회 -->
    <select id="getOcrDocumentDetail" parameterType="map" resultType="com.refine.ocr.vo.OcrInfoVO">
        SELECT *
        FROM ocr_doc_inf
        WHERE ocr_doc_no = #{ocr_doc_no}
    </select>
    
    <!-- 관리번호별 서류 목록 조회 -->
    <select id="getDocumentListByCtrlNo" parameterType="map" resultType="com.refine.ocr.vo.OcrInfoVO">
        SELECT *
        FROM ocr_doc_inf
        WHERE ctrl_yr = #{ctrl_yr}
        AND inst_cd = #{inst_cd}
        AND prdt_cd = #{prdt_cd}
        AND ctrl_no = #{ctrl_no}
        ORDER BY ins_dttm DESC
    </select>
    
    <!-- OCR 결과 텍스트 조회 -->
    <select id="getOcrResultText" parameterType="map" resultType="com.refine.ocr.vo.OcrInfoVO">
        SELECT *
        FROM ocr_doc_rslt
        WHERE ocr_doc_no = #{ocr_doc_no}
        ORDER BY item_cd
    </select>
    
    <!-- OCR 문서 번호 리스트 조회 -->
    <select id="getOcrDocNoList" parameterType="map" resultType="String">
        SELECT ocr_doc_no
        FROM ocr_doc_inf
        WHERE ctrl_yr = #{ctrl_yr}
        AND inst_cd = #{inst_cd}
        AND prdt_cd = #{prdt_cd}
        AND ctrl_no = #{ctrl_no}
        ORDER BY ins_dttm DESC
    </select>
    
    <!-- 검증 상태 업데이트 -->
    <update id="updateVerificationStatus" parameterType="map">
        UPDATE ocr_doc_inf
        SET vrfy_stat_cd = #{vrfy_stat_cd},
            upd_dttm = NOW()
        WHERE ocr_doc_no = #{ocr_doc_no}
    </update>
    
    <!-- 이미지 정보 조회 -->
    <select id="getImageInfo" parameterType="map" resultType="com.refine.ocr.vo.OcrInfoVO">
        SELECT *
        FROM ocr_doc_inf
        WHERE ocr_doc_no = #{ocr_doc_no}
    </select>
    
    <!-- 상품 분류 조회 -->
    <select id="getSysClsCd" parameterType="map" resultType="String">
        SELECT prdt_cls_cd
        FROM c_prdt
        WHERE inst_cd = #{instCd}
        AND prdt_cd = #{prdtCd}
    </select>
    
    <!-- 최대 CTRL_NO 조회 -->
    <select id="getMaxCtrlNo" parameterType="map" resultType="String">
        SELECT LPAD(MAX(CAST(ctrl_no AS INTEGER))::TEXT, 6, '0')
        FROM ocr_doc_inf
        WHERE inst_cd = #{inst_cd}
        AND prdt_cd = #{prdt_cd}
    </select>
    
    <!-- 사용자별 OCR 문서 번호 조회 -->
    <select id="getOcrDocNoListByUserId" parameterType="map" resultType="String">
        SELECT ocr_doc_no
        FROM ocr_doc_inf
        WHERE inst_cd = #{inst_cd}
        AND prdt_cd = #{prdt_cd}
        AND ins_id = #{ins_id}
    </select>
    
    <!-- 사용자 테스트 파일 경로 리스트 조회 -->
    <select id="getUserTestFilePathList" parameterType="map" resultType="String">
        SELECT doc_fl_sav_pth_nm
        FROM ocr_doc_inf
        WHERE inst_cd = #{inst_cd}
        AND prdt_cd = #{prdt_cd}
        AND ins_id = #{ins_id}
        AND doc_fl_sav_pth_nm IS NOT NULL
    </select>
    
    <!-- OCR 결과 삭제 -->
    <delete id="deleteOcrResult" parameterType="map">
        DELETE FROM ocr_doc_rslt
        WHERE ocr_doc_no = #{ocr_doc_no}
    </delete>
    
    <!-- OCR 문서 삭제 -->
    <delete id="deleteOcrDocument" parameterType="map">
        DELETE FROM ocr_doc_inf
        WHERE ocr_doc_no = #{ocr_doc_no}
        AND inst_cd = '99'
        AND prdt_cd = 'OCR'
    </delete>
    
    <!-- 사용자 테스트 문서 삭제 -->
    <delete id="deleteUserTestDocuments" parameterType="map">
        DELETE FROM ocr_doc_inf
        WHERE inst_cd = #{inst_cd}
        AND prdt_cd = #{prdt_cd}
        AND ins_id = #{ins_id}
    </delete>
    
    <!-- OCR 문서 등록 -->
    <insert id="insertOcrDocument" parameterType="map">
        INSERT INTO ocr_doc_inf (
            ocr_doc_no,
            doc_fl_no,
            ctrl_yr,
            inst_cd,
            prdt_cd,
            ctrl_no,
            doc_tp_cd,
            doc_fl_nm,
            doc_fl_sav_pth_nm,
            doc_fl_ext,
            ins_dttm,
            ins_id,
            upd_dttm,
            upd_id,
            enc_yn,
            menu_cd,
            priority
        ) SELECT
            nextval('seq_ocr_doc_no'),
            nextval('seq_doc_fl_no'),
            #{ctrl_yr},
            #{inst_cd},
            #{prdt_cd},
            #{ctrl_no},
            #{doc_tp_cd},
            #{doc_fl_nm},
            #{doc_fl_sav_pth_nm},
            #{doc_fl_ext},
            NOW(),
            #{ins_id},
            NOW(),
            #{upd_id},
            #{enc_yn},
            #{menu_cd},
            #{priority}
        WHERE NOT EXISTS (
            SELECT 1
            FROM ocr_doc_inf
            WHERE ctrl_yr = #{ctrl_yr}
            AND inst_cd = #{inst_cd}
            AND prdt_cd = #{prdt_cd}
            AND ctrl_no = #{ctrl_no}
            AND doc_tp_cd = #{doc_tp_cd}
            AND doc_fl_nm = #{doc_fl_nm}
        )
    </insert>
    
</mapper>
